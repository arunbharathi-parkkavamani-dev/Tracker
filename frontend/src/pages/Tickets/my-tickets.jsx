import { useState, useEffect } from 'react';\nimport axiosInstance from '../../api/axiosInstance';\nimport { useAuth } from '../../context/authProvider';\nimport TableGenerator from '../../components/Common/TableGenerator';\nimport FormRenderer from '../../components/Common/FormRenderer';\nimport { Plus, User } from 'lucide-react';\n\nconst MyTickets = () => {\n  const { user } = useAuth();\n  const [tickets, setTickets] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [editingTicket, setEditingTicket] = useState(null);\n\n  useEffect(() => {\n    fetchMyTickets();\n  }, []);\n\n  const fetchMyTickets = async () => {\n    try {\n      setLoading(true);\n      const response = await axiosInstance.get(`/populate/read/tickets?filter={\"$or\":[{\"createdBy\":\"${user.id}\"},{\"assignedTo\":\"${user.id}\"}]}&fields=assignedTo,accountManager,createdBy,linkedTaskId`);\n      const ticketsData = response.data.data || [];\n      setTickets(ticketsData);\n    } catch (error) {\n      console.error('Error fetching my tickets:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleCreateTicket = async (formData) => {\n    try {\n      await axiosInstance.post('/populate/create/tickets', {\n        ...formData,\n        createdBy: user.id\n      });\n      fetchMyTickets();\n      setShowCreateModal(false);\n    } catch (error) {\n      console.error('Error creating ticket:', error);\n      throw error;\n    }\n  };\n\n  const handleUpdateTicket = async (formData) => {\n    try {\n      await axiosInstance.put(`/populate/update/tickets/${editingTicket._id}`, formData);\n      fetchMyTickets();\n      setEditingTicket(null);\n    } catch (error) {\n      console.error('Error updating ticket:', error);\n      throw error;\n    }\n  };\n\n  const handleEdit = (ticket) => {\n    setEditingTicket(ticket);\n  };\n\n  const ticketFormFields = [\n    { name: 'title', label: 'Title', type: 'text', placeholder: 'Brief description of the issue', gridClass: 'col-span-2' },\n    { name: 'userStory', label: 'Description', type: 'textarea', placeholder: 'Detailed description of the issue...', rows: 4, gridClass: 'col-span-2' },\n    { name: 'product', label: 'Product', type: 'text', placeholder: 'Product name' },\n    { name: 'type', label: 'Type', type: 'AutoComplete', source: '', options: [\n      { _id: 'Bug', name: 'Bug' },\n      { _id: 'Feature', name: 'Feature' },\n      { _id: 'Enhancement', name: 'Enhancement' },\n      { _id: 'Support', name: 'Support' }\n    ]},\n    { name: 'priority', label: 'Priority', type: 'AutoComplete', source: '', options: [\n      { _id: 'Low', name: 'Low' },\n      { _id: 'Medium', name: 'Medium' },\n      { _id: 'High', name: 'High' },\n      { _id: 'Critical', name: 'Critical' }\n    ]},\n    { name: 'dueDate', label: 'Due Date', type: 'date' }\n  ];\n\n  const customRender = {\n    type: (ticket) => (\n      <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200\">\n        {ticket.type || 'Bug'}\n      </span>\n    ),\n    userStory: (ticket) => (\n      <span className=\"max-w-[250px] truncate block\" title={ticket.userStory}>\n        {ticket.userStory || ticket.description || '-'}\n      </span>\n    ),\n    status: (ticket) => {\n      const colors = {\n        'Open': 'bg-blue-50 text-blue-700 border-blue-200',\n        'In Progress': 'bg-orange-50 text-orange-700 border-orange-200',\n        'Review': 'bg-purple-50 text-purple-700 border-purple-200',\n        'Testing': 'bg-cyan-50 text-cyan-700 border-cyan-200',\n        'Completed': 'bg-green-50 text-green-700 border-green-200',\n        'Closed': 'bg-gray-50 text-gray-700 border-gray-200'\n      };\n      return (\n        <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border ${colors[ticket.status] || 'bg-gray-50 text-gray-700 border-gray-200'}`}>\n          {ticket.status}\n        </span>\n      );\n    },\n    createdAt: (ticket) => (\n      <span>{new Date(ticket.createdAt).toLocaleDateString()}</span>\n    ),\n    __actions: (ticket) => (\n      <button\n        onClick={() => handleEdit(ticket)}\n        className=\"px-3 py-1 text-xs font-medium rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors\"\n      >\n        Edit\n      </button>\n    )\n  };\n\n  const myCreatedTickets = tickets.filter(t => t.createdBy?._id === user.id).length;\n  const myAssignedTickets = tickets.filter(t => t.assignedTo?.some(a => a._id === user.id)).length;\n  const openTickets = tickets.filter(t => t.status === 'Open').length;\n\n  if (loading) return (\n    <div className=\"flex items-center justify-center h-64\">\n      <div className=\"text-lg\">Loading tickets...</div>\n    </div>\n  );\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight flex items-center gap-2\">\n            <User className=\"h-6 w-6\" />\n            My Tickets\n          </h1>\n          <p className=\"text-gray-600 text-sm\">Tickets created by you or assigned to you</p>\n        </div>\n        <button \n          onClick={() => setShowCreateModal(true)}\n          className=\"bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm hover:bg-blue-700 transition-colors flex items-center gap-2\"\n        >\n          <Plus className=\"h-4 w-4\" />\n          New Ticket\n        </button>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <div className=\"bg-blue-50/50 border border-blue-100 rounded-lg p-4\">\n          <div className=\"pb-2\">\n            <h3 className=\"text-sm font-medium text-blue-600\">Created by Me</h3>\n          </div>\n          <div className=\"text-2xl font-bold\">{myCreatedTickets}</div>\n        </div>\n        \n        <div className=\"bg-green-50/50 border border-green-100 rounded-lg p-4\">\n          <div className=\"pb-2\">\n            <h3 className=\"text-sm font-medium text-green-600\">Assigned to Me</h3>\n          </div>\n          <div className=\"text-2xl font-bold\">{myAssignedTickets}</div>\n        </div>\n        \n        <div className=\"bg-orange-50/50 border border-orange-100 rounded-lg p-4\">\n          <div className=\"pb-2\">\n            <h3 className=\"text-sm font-medium text-orange-600\">Open Tickets</h3>\n          </div>\n          <div className=\"text-2xl font-bold\">{openTickets}</div>\n        </div>\n      </div>\n\n      {/* Table */}\n      <TableGenerator\n        data={tickets}\n        customRender={customRender}\n        hiddenColumns={['_id', 'updatedAt', 'ticketId', 'createdBy', 'assignedTo', 'accountManager', 'department', 'clientId', 'taskTypeId', 'isConvertedToTask', 'convertedBy', 'convertedAt', 'attachments', 'startDate', 'liveHours', 'comments', 'resolvedAt', 'closedAt', 'resolution', 'description', 'impactAnalysis', 'url', 'acceptanceCriteria', 'linkedTaskId', 'dueDate', 'product', 'priority']}\n        enableActions={true}\n        onEdit={handleEdit}\n      />\n      \n      {/* Create Ticket Modal */}\n      {showCreateModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4\">\n            <div className=\"flex justify-between items-center p-6 border-b\">\n              <h2 className=\"text-xl font-semibold\">Create New Ticket</h2>\n              <button onClick={() => setShowCreateModal(false)} className=\"text-gray-500 hover:text-gray-700\">\n                ×\n              </button>\n            </div>\n            <div className=\"p-6\">\n              <FormRenderer\n                fields={ticketFormFields}\n                onSubmit={handleCreateTicket}\n                submitButton={{ text: 'Create Ticket', color: 'blue' }}\n              />\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Edit Ticket Modal */}\n      {editingTicket && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4\">\n            <div className=\"flex justify-between items-center p-6 border-b\">\n              <h2 className=\"text-xl font-semibold\">Edit Ticket</h2>\n              <button onClick={() => setEditingTicket(null)} className=\"text-gray-500 hover:text-gray-700\">\n                ×\n              </button>\n            </div>\n            <div className=\"p-6\">\n              <FormRenderer\n                fields={ticketFormFields}\n                data={editingTicket}\n                onSubmit={handleUpdateTicket}\n                submitButton={{ text: 'Update Ticket', color: 'green' }}\n              />\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default MyTickets;