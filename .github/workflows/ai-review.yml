name: AI Code Review

on:
  push:
    branches:
      - main
      - Arun
      - staging
      - ai-review
  pull_request:
    branches:
      - main
      - Arun
      - staging
      - ai-review

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install openai@4.0.0 simple-git@3.21.0

      - name: Generate AI Code Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          node <<'EOF'
          import fs from 'fs';
          import { execSync } from 'child_process';
          import OpenAI from 'openai';

          const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

          // Detect if we're in the ai-review branch
          const branch = execSync('git rev-parse --abbrev-ref HEAD', { encoding: 'utf8' }).trim();
          let content = '';

          if (branch.includes('review')) {
            // console.log('ðŸ“¦ Performing full project review...');
            // Get all project files except node_modules
            const files = execSync('find . -type f ! -path "./node_modules/*" ! -path "./.git/*" -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx"', { encoding: 'utf8' });
            const limitedFiles = files.split('\n').slice(0, 20).join('\n'); // Limit for large projects
            content = execSync(`cat ${limitedFiles}`, { encoding: 'utf8', maxBuffer: 1024 * 1000 });
          } else {
            // console.log('ðŸ§© Performing diff-based review...');
            content = execSync('git diff HEAD~1 HEAD', { encoding: 'utf8' });
          }

          const prompt = `
          You are a senior full-stack reviewer (React, React Native, Express, and Node).
          Review the following codebase or diff.
          Identify key architectural issues, design inconsistencies, or optimizations.
          Output a markdown-formatted summary with sections: Overview, Positives, Issues, Suggestions, Overall.
          
          Code Input:
          ${content}
          `;

          const runReview = async () => {
            const response = await openai.chat.completions.create({
              model: "gpt-4o-mini",
              messages: [
                { role: "system", content: "You are an expert code reviewer and software architect." },
                { role: "user", content: prompt }
              ],
              temperature: 0.4,
            });

            const review = response.choices[0].message.content;
            const date = new Date().toLocaleString();
            const output = `\n\n---\n### ðŸ§  AI Review (${date})\n${review}\n`;

            fs.appendFileSync('./text.md', output);
            // console.log('âœ… Review added to text.md');
          };

          await runReview();
          EOF

      - name: Commit and push review file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add text.md
          git commit -m "ðŸ¤– AI code review update"
          git push
